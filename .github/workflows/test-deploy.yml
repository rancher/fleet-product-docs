name: Test deployment

on:
  pull_request:
    paths-ignore:
      - '**/README.md'
    types: [opened, edited, synchronize, reopened]

jobs:
  # ============================================================
  # Community docs build
  # ============================================================
  test-community:
    name: Test community docs
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          submodules: recursive

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18

      - name: Install Antora and dependencies
        run: make environment

      - name: Build community site
        run: |
          set -o pipefail
          npx antora --stacktrace \
            --log-format=pretty \
            --log-level=info \
            --log-failure-level=warn \
            fleet-community-local-playbook.yml \
            2>&1 | tee community-build.log

          if grep -q "INFO (asciidoctor)" community-build.log; then
            echo "Asciidoctor warnings found"
            exit 1
          fi

      - name: Check community nav entries
        run: bin/files-missing-nav

  # ============================================================
  # Product docs build
  # ============================================================
  test-product:
    name: Test product docs
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          submodules: recursive

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18

      - name: Install Antora and dependencies
        run: make environment

      - name: Build product site
        run: |
          set -o pipefail
          npx antora --stacktrace \
            --log-format=pretty \
            --log-level=info \
            --log-failure-level=warn \
            fleet-product-local-playbook.yml \
            2>&1 | tee product-build.log

          if grep -q "INFO (asciidoctor)" product-build.log; then
            echo "Asciidoctor warnings found"
            exit 1
          fi

      - name: Check product nav entries
        run: bin/files-missing-nav
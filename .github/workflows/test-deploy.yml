name: Test deployment

on:
  pull_request:
    paths-ignore:
      - '**/README.md'
    types: [opened, edited, synchronize, reopened]

jobs:
  test-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository (with submodules)
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18

      - name: Install Antora and dependencies
        run: make environment

      # ------------------------------------------------------------------
      # Community docs
      # ------------------------------------------------------------------
      - name: Switch to community documentation context
        run: |
          chmod +x ./bin/switch-prod-comm
          ./bin/switch-prod-comm community

      - name: Build community site
        run: |
          npx antora --stacktrace \
            --log-file community-build.log \
            --log-format=pretty \
            --log-level=info \
            --log-failure-level=warn \
            fleet-community-local-playbook.yml 2>&1 | tee community-build.log

          BUILD_STATUS=${PIPESTATUS[0]}

          # Fail build on asciidoctor warnings
          if grep "INFO (asciidoctor)" community-build.log; then
            BUILD_STATUS=1
          fi

          echo "COMMUNITY_BUILD_STATUS=$BUILD_STATUS" >> $GITHUB_ENV

      - name: Check community nav entries
        run: bin/files-missing-nav

      - name: Fail if community build failed
        run: |
          if [ "${{ env.COMMUNITY_BUILD_STATUS }}" -ne "0" ]; then
            cat community-build.log
            exit 1
          fi

      # ------------------------------------------------------------------
      # Product docs
      # ------------------------------------------------------------------
      - name: Switch to product documentation context
        run: |
          chmod +x ./bin/switch-prod-comm
          ./bin/switch-prod-comm product

      - name: Build product site
        run: |
          npx antora --stacktrace \
            --log-file product-build.log \
            --log-format=pretty \
            --log-level=info \
            --log-failure-level=warn \
            fleet-product-local-playbook.yml 2>&1 | tee product-build.log

          BUILD_STATUS=${PIPESTATUS[0]}

          # Fail build on asciidoctor warnings
          if grep "INFO (asciidoctor)" product-build.log; then
            BUILD_STATUS=1
          fi

          echo "PRODUCT_BUILD_STATUS=$BUILD_STATUS" >> $GITHUB_ENV

      - name: Check product nav entries
        run: bin/files-missing-nav

      - name: Fail if product build failed
        run: |
          if [ "${{ env.PRODUCT_BUILD_STATUS }}" -ne "0" ]; then
            cat product-build.log
            exit 1
          fi
